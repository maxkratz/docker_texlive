kind: pipeline
name: default

auth: &auth
    username:
        from_secret: dockerhub_username
    password:
        from_secret: dockerhub_password

repo: &repo
    repo: maxkratz/texlive

#steps:
#  - name: build-base
#    image: plugins/docker
#    settings:
#        dockerfile: Dockerfile
#        <<: *repo
#        tags:
#            - base
#        <<: *auth
#    when:
#        branch:
#            - main
#            - base

steps:
  - name: build-base
    image: docker:dind
    volumes:
      - name: dockersock
        path: /var/run
    commands:
      - sleep 5 # wait a bit for Docker to start
      - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
      - docker buildx create --name builder --driver docker-container --use
      - docker buildx inspect --bootstrap
      - docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t maxkratz/texlive:base .

services:
  - name: docker
    image: docker:dind
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run

volumes:
  - name: dockersock
    temp: {}
